# Sistema de Acciones Premium

## Descripci칩n
El sistema de acciones premium es un mecanismo centralizado para registrar y controlar el uso de funcionalidades premium en la aplicaci칩n. Esto nos permite tener un seguimiento detallado del uso de estas caracter칤sticas y aplicar l칤mites seg칰n el rol del usuario y su ciclo de suscripci칩n.

## Tipos de Acciones Premium
Actualmente se registran dos tipos de acciones premium:
1. `profile_analysis`: An치lisis del perfil de LinkedIn con IA
2. `post_optimization`: Optimizaci칩n de publicaciones con IA

## Estructura de Datos

### Tabla `premium_actions`
Las acciones premium se almacenan en la tabla `premium_actions` con la siguiente estructura:
- `id`: Identificador 칰nico de la acci칩n
- `user_id`: ID del usuario que realiz칩 la acci칩n
- `action_type`: Tipo de acci칩n ('profile_analysis' o 'post_optimization')
- `created_at`: Fecha y hora de la acci칩n
- `metadata`: Datos adicionales espec칤ficos de la acci칩n en formato JSON

### Tabla `premium_limits`
Los l칤mites de acciones premium se gestionan din치micamente a trav칠s de la tabla `premium_limits`:
- `id`: Identificador 칰nico del l칤mite
- `role`: Rol del usuario ('FREE', 'PREMIUM', 'PRO')
- `action_type`: Tipo de acci칩n
- `limit_type`: Tipo de l칤mite ('days_between_analysis', 'max_per_post', 'monthly_limit')
- `limit_value`: Valor num칠rico del l칤mite

### Tabla `user_profiles`
La tabla `user_profiles` se ha actualizado para incluir campos relacionados con la suscripci칩n:
- `subscription_start_date`: Fecha de inicio de la suscripci칩n actual
- `next_billing_date`: Fecha de la pr칩xima facturaci칩n
- `role`: Rol actual del usuario
- `trial_ends_at`: Fecha de finalizaci칩n del per칤odo de prueba
- `subscription_expiry`: Fecha de expiraci칩n de la suscripci칩n

## Ciclos de Suscripci칩n
- Los l칤mites mensuales se calculan bas치ndose en el ciclo de suscripci칩n del usuario
- El ciclo comienza en la fecha de suscripci칩n y se renueva el mismo d칤a cada mes
- Para meses con menos d칤as, la renovaci칩n ocurre el 칰ltimo d칤a del mes
- Los l칤mites se restablecen al inicio de cada ciclo

## Funciones Especiales

### `calculate_next_billing_date`
Calcula la pr칩xima fecha de facturaci칩n teniendo en cuenta:
- D칤as del mes (28, 29, 30, 31)
- Ajuste autom치tico para meses m치s cortos

### `get_current_cycle_actions`
Obtiene las acciones realizadas en el ciclo actual de suscripci칩n:
- Filtra por fecha de inicio del ciclo
- Cuenta acciones hasta la pr칩xima fecha de facturaci칩n

## Verificaci칩n de L칤mites
El sistema verifica dos tipos de l칤mites:
1. **L칤mites de Tiempo:**
   - D칤as m칤nimos entre an치lisis de perfil
2. **L칤mites de Cantidad:**
   - N칰mero m치ximo de acciones por ciclo de facturaci칩n
   - N칰mero m치ximo de optimizaciones por post

## Gesti칩n de Roles y Transiciones
- Los usuarios FREE tienen l칤mites b치sicos
- Los usuarios PREMIUM y PRO tienen l칤mites expandidos seg칰n su plan
- Al cambiar de rol, los l칤mites se actualizan inmediatamente
- Al expirar una suscripci칩n, el usuario vuelve al rol FREE

# Sistema de Roles y Permisos

## Estructura de la Base de Datos

La gesti칩n de roles y permisos se maneja a trav칠s de dos tablas principales en Supabase:

1. `user_profiles`: Almacena la informaci칩n b치sica del usuario y su rol
```sql
create table if not exists public.user_profiles (
  id uuid references auth.users on delete cascade not null primary key,
  role text not null default 'FREE',
  is_beta_tester boolean default false,
  trial_ends_at timestamptz default (now() + interval '15 days'),
  subscription_expiry timestamptz,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  
  constraint role_check check (role in ('FREE', 'PREMIUM', 'PRO'))
);
```

2. `premium_limits`: Almacena los l칤mites de acciones premium por rol
```sql
create table if not exists public.premium_limits (
  id bigint generated by default as identity primary key,
  role text not null,
  action_type text not null,
  limit_type text not null,
  limit_value integer not null,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),

  constraint role_check check (role in ('FREE', 'PREMIUM', 'PRO', 'BETA_TESTER')),
  constraint action_type_check check (action_type in ('profile_analysis', 'post_optimization')),
  constraint limit_type_check check (limit_type in ('days_between_analysis', 'max_per_post', 'monthly_limit')),
  unique(role, action_type, limit_type)
);
```

### Tipos de Roles

1. **FREE**
   - Acceso a funcionalidades b치sicas
   - Sin acceso a caracter칤sticas premium

2. **PREMIUM**
   - Acceso a todas las funcionalidades b치sicas
   - Acceso a caracter칤sticas premium con l칤mites est치ndar
   - L칤mites configurables en la tabla `premium_limits`

3. **PRO**
   - Incluye todas las caracter칤sticas de PREMIUM
   - L칤mites m치s altos configurables en la tabla `premium_limits`

### Beta Testers
Los beta testers son usuarios que tienen acceso anticipado a nuevas funcionalidades, independientemente de su rol base:
- Cualquier usuario (FREE, PREMIUM, PRO) puede ser beta tester
- Se gestiona mediante el campo `is_beta_tester` en la tabla `user_profiles`
- Los beta testers tienen acceso a todas las funcionalidades marcadas como beta

### Implementaci칩n en el Frontend

#### Hook useUserRole

El hook `useUserRole` proporciona una interfaz para manejar los roles y permisos:

```typescript
const {
  role,                // Rol actual del usuario ('FREE', 'PREMIUM', 'PRO')
  loading,             // Estado de carga
  error,               // Error si lo hay
  isPremium,           // Funci칩n que verifica si el usuario tiene acceso premium
  isBetaTester,        // Si el usuario es beta tester
  hasAccess,           // Funci칩n para verificar acceso a funcionalidades
  canAccessBetaFeature // Funci칩n espec칤fica para verificar acceso a features beta
} = useUserRole();
```

#### Verificaci칩n de Acceso

```typescript
// Para funcionalidades premium
if (hasAccess('premium_feature_name')) {
  // Mostrar funcionalidad premium
} else {
  // Mostrar banner de actualizaci칩n
}

// Para funcionalidades beta
if (canAccessBetaFeature('beta_feature_name')) {
  // Mostrar funcionalidad beta
} else {
  // Ocultar o deshabilitar la funcionalidad
}
```

### Nomenclatura de Features
- Features premium: `premium_feature_name`
- Features beta: `beta_feature_name`
- Features b치sicas: `feature_name`

### Verificaci칩n de Acceso Premium
El acceso premium se verifica considerando:
1. Rol del usuario (PREMIUM o PRO)
2. Estado del per칤odo de prueba
3. Estado de la suscripci칩n

### Verificaci칩n de Acceso Beta
El acceso beta se verifica 칰nicamente por el campo `is_beta_tester`

### Administraci칩n

#### Actualizar Rol de Usuario
```sql
update user_profiles
set role = 'PREMIUM'
where id = 'USER_ID';
```

#### Gestionar Beta Testers
```sql
-- Hacer beta tester
update user_profiles
set is_beta_tester = true
where id = 'USER_ID';

-- Quitar acceso beta
update user_profiles
set is_beta_tester = false
where id = 'USER_ID';
```

### Gesti칩n de L칤mites

Los l칤mites se gestionan a trav칠s del hook `usePremiumActions`:

```typescript
const { 
  checkProfileAnalysisLimit, 
  checkPostOptimizationLimit,
  registerAction,
  loading,
  error,
  limits
} = usePremiumActions();

// Verificar l칤mites antes de una acci칩n
const canPerformAnalysis = await checkProfileAnalysisLimit();
if (!canPerformAnalysis) {
  // Mostrar mensaje de l칤mite alcanzado
}

// Registrar una acci칩n realizada
await registerAction('profile_analysis', {
  analysis_id: '123',
  timestamp: new Date().toISOString()
});
```

### Administraci칩n de L칤mites

Para modificar los l칤mites de acciones premium:

```sql
-- Actualizar un l칤mite espec칤fico
update premium_limits
set limit_value = 50
where role = 'PRO' 
  and action_type = 'post_optimization'
  and limit_type = 'monthly_limit';

-- Consultar l칤mites actuales
select * from premium_limits
where role = 'PREMIUM'
order by action_type, limit_type;
```

### Consideraciones de Seguridad

1. **RLS (Row Level Security)**
   - Implementado en todas las tablas relevantes
   - Los usuarios solo pueden ver y modificar sus propios datos
   - Los l칤mites son de solo lectura para los usuarios

2. **Verificaci칩n en M칰ltiples Capas**
   - Frontend: A trav칠s de los hooks `useUserRole` y `usePremiumActions`
   - Backend: Mediante pol칤ticas RLS y funciones RPC
   - Base de datos: Constraints y checks en las tablas

3. **Auditor칤a**
   - Todas las acciones premium se registran en la tabla `premium_actions`
   - Cada registro incluye metadata para an치lisis detallado
   - Timestamps autom치ticos para seguimiento temporal 

# Componentes de UI

## Sidebar

### Estructura
El Sidebar es un componente colapsable que proporciona navegaci칩n y muestra informaci칩n del usuario:
- Logo y nombre de la aplicaci칩n
- Men칰 de navegaci칩n
- Estad칤sticas de uso del plan
- Bot칩n de cerrar sesi칩n

### UsageStats
El componente UsageStats muestra informaci칩n sobre el uso de funcionalidades premium:

1. **Visualizaci칩n Colapsada**
   - Muestra solo el icono del plan actual:
     - 游 (Rocket) para plan PRO
     - 游녬 (Crown) para plan PREMIUM
     - 游녻 (User) para plan FREE

2. **Visualizaci칩n Expandida**
   - Muestra las barras de progreso de uso
   - Indica los l칤mites num칠ricos (usado/total)
   - Muestra el nombre del plan debajo del icono

3. **Barras de Progreso**
   - An치lisis de Perfil: Muestra el uso actual vs l칤mite
   - Optimizaciones: Muestra el uso mensual vs l칤mite
   - Gradiente azul a 칤ndigo para indicar el progreso

4. **Actualizaci칩n Autom치tica**
   - Los datos se cargan al montar el componente
   - Se actualizan cuando cambia el rol del usuario
   - Consulta los l칤mites espec칤ficos del rol desde la base de datos

### Ejemplo de Uso
```tsx
// En el Sidebar
<div className="flex flex-col h-full">
  {/* ... navegaci칩n ... */}
  <UsageStats />
  {/* ... bot칩n de cerrar sesi칩n ... */}
</div>
```

### Consideraciones de Dise침o
1. **Responsividad**
   - El componente se adapta al estado colapsado/expandido del Sidebar
   - Las transiciones son suaves para mejorar la UX
   - Los textos usan `whitespace-nowrap` para evitar saltos de l칤nea

2. **Accesibilidad**
   - Los iconos tienen colores distintivos para cada plan
   - Los n칰meros son claramente legibles
   - Las barras de progreso tienen suficiente contraste

3. **Estado de Carga**
   - Los valores se inicializan en 0
   - Se muestran los datos reales una vez cargados
   - Manejo de errores silencioso para no interrumpir la UX

# Gesti칩n de Posts

## Estados de Post

Los estados de post se manejan mediante un tipo ENUM en la base de datos:

```sql
CREATE TYPE post_state AS ENUM (
  'borrador',
  'listo',
  'planificado',
  'eliminado'
);
```

Los posts pueden tener los siguientes estados:

1. **borrador**
   - Post en proceso de edici칩n
   - No visible en el calendario
   - Puede ser modificado libremente

2. **listo**
   - Post finalizado pero pendiente de publicar
   - Visible en la lista pero no en el calendario
   - Puede ser publicado manualmente

3. **planificado**
   - Post programado para una fecha espec칤fica
   - Visible tanto en la lista como en el calendario
   - La fecha de publicaci칩n puede ser modificada

4. **eliminado**
   - Post marcado como eliminado (soft delete)
   - No visible en ninguna vista
   - Mantiene sus relaciones con otras tablas (optimizaciones, etc)
   - No puede ser modificado ni recuperado

### Modificaci칩n del ENUM
Para a침adir nuevos estados, se debe modificar el tipo ENUM:
```sql
-- A침adir nuevo valor al enum
ALTER TYPE post_state ADD VALUE IF NOT EXISTS 'nuevo_estado';
```

Nota: Los valores ENUM solo se pueden a침adir, no modificar ni eliminar una vez creados.

## Implementaci칩n del Soft Delete

Para preservar la integridad referencial y el historial de optimizaciones, los posts no se eliminan f칤sicamente de la base de datos. En su lugar:

1. Se marcan como 'eliminado' mediante el estado ENUM
2. Se filtran autom치ticamente en todas las consultas
3. Mantienen sus relaciones con otras tablas (post_optimizations, etc)

### Ejemplo de Implementaci칩n

```typescript
// Al cargar posts
const loadPosts = async () => {
  const { data, error } = await supabase
    .from('posts')
    .select('*')
    .neq('state', 'eliminado')
    .order('created_at', { ascending: false });
};

// Al "eliminar" un post
const deletePost = async (postId: string) => {
  const { error } = await supabase
    .from('posts')
    .update({ state: 'eliminado' })
    .eq('id', postId);
};
```

### Consideraciones

1. **Filtrado Autom치tico**
   - Todas las consultas deben incluir el filtro `state != 'eliminado'`
   - Esto aplica tanto para la lista como para el calendario

2. **Integridad de Datos**
   - Los posts eliminados mantienen sus optimizaciones y metadatos
   - Esto permite mantener estad칤sticas e hist칩ricos precisos

3. **Rendimiento**
   - El soft delete no impacta significativamente el rendimiento
   - Los 칤ndices en la columna `state` optimizan las consultas

# Gu칤a del Proyecto

## Estructura del Proyecto

### Frontend (Next.js + Vite)
- `src/components/` - Componentes React
  - `Pricing.tsx` - P치gina de planes y precios
  - `SuccessPage.tsx` - P치gina post-compra
- `src/lib/` - Utilidades y configuraci칩n
  - `stripe.ts` - Cliente de Stripe y funciones relacionadas
  - `supabase.ts` - Cliente de Supabase

### Backend (Supabase)
- Tablas principales:
  - `user_profiles` - Perfiles de usuario y suscripciones
  - `posts` - Posts de LinkedIn
  - `stripe_customers` - Clientes de Stripe
  - `stripe_subscriptions` - Suscripciones activas

- Edge Functions:
  - `create-checkout-session` - Crear sesi칩n de pago
  - `create-portal-session` - Portal de cliente Stripe
  - `stripe-webhook` - Webhook para eventos de Stripe

## Flujo de Suscripci칩n

1. Usuario accede a `/pricing`
2. Selecciona un plan (PREMIUM o PRO)
3. Se crea sesi칩n de checkout en Stripe
4. Usuario completa el pago
5. Webhook actualiza:
   - `stripe_customers`
   - `stripe_subscriptions`
   - `user_profiles` (role, fechas, estado)

## Gesti칩n de Suscripciones

### Roles de Usuario
- FREE: Acceso b치sico
- PREMIUM: Funcionalidades premium
- PRO: Todas las funcionalidades

### Estados de Suscripci칩n
- free: Sin suscripci칩n activa
- active: Suscripci칩n vigente
- canceled: Cancelada
- trialing: En per칤odo de prueba

### Funciones de Gesti칩n Manual
```sql
-- Hacer PREMIUM
SELECT set_user_premium('uuid-del-usuario');

-- Hacer PRO
SELECT set_user_pro('uuid-del-usuario');

-- Hacer FREE
SELECT set_user_free('uuid-del-usuario');
```

## Variables de Entorno

### Desarrollo (.env.development)
```env
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...
```

### Producci칩n (.env.production)
```env
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_...
```

### Supabase Edge Functions
```env
STRIPE_SECRET_KEY=sk_test/live_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

## Pruebas

### Tarjetas de Prueba
- 칄xito: 4242 4242 4242 4242
- Cualquier fecha futura
- Cualquier CVC
- Cualquier c칩digo postal

### Verificaci칩n
1. Comprobar creaci칩n en `stripe_customers`
2. Verificar suscripci칩n en `stripe_subscriptions`
3. Confirmar actualizaci칩n en `user_profiles`

## Mantenimiento

### Monitorizaci칩n
- Dashboard de Stripe
- Logs de Supabase Functions
- Estado de suscripciones

### Backups
- Respaldo de IDs de productos/precios
- Configuraci칩n documentada
- Variables de entorno seguras

